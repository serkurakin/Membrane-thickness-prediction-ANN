# Нейронная сеть для количественного определения структурных параметров нанообъектов по экспериментальным данным

# Цель работы:
Определение толщины клеточных липидных мембран, приготовленных в форме однослойных везикул, по экспериментальным данным малоуглового рассеяния нейтронов
с помощью нейронной сети

# Описание задачи:
Малоугловое рассеяние нейтронов - мощный исследовательский экспериментальный метод для определения структуры вещества, в том числе и структуры биологических объектов. 
В России этот метод реализован на спектрометре малоуглового рассеяния нейтронов ЮМО, установленном на исследовательском ядерном реакторе ИБР-2 (ОИЯИ, г.Дубна). 
Результатом измерения этим методом образцов липидных мембран, приготовленных в форме сферических однослойных везикул, находящихся в водном растворе,
является кривая малоуглового рассеяния нейтронов (зависимость интенсивности рассеянных нейтронов от переданного импульса q). 
Эта кривая в дальнейшем аналитически аппроксимируется (фитируется) специальными моделями для количественного расчета таких ключевых структурных параметров 
липидных мембран, как толщина липидной мембраны, радиус везикул, полидисперсность по размерам и др. Наиболее распространенные программы для фитирования - Sasview, Sasfit.
Однако данный процесс фитирования не всегда является тривиальным, поскольку требует тщательного подбора самой модели, структурных параметров модели,
области фитирования кривой и т.д., что весьма затруднительно для неспециалистов в малоугловом рассеянии нейтронов.
В то же время быстрая оценка структурных параметров позволяет в процессе эксперимента оперативно менять условия эксперимента, время измерения, состояние образца,
внешнее окружение и т.д. в зависимости от получаемого результата in-situ. Таким образом, применение нейросети для задачи обучения с учителем, 
где целевым признаком является толщина липидной мембраны, упростит анализ кривых малоуглового рассеяния и предоставит новые возможности
для оперативного управления экспериментом.

![Graphical abstract](https://github.com/serkurakin/Membrane-thickness-prediction-ANN/blob/main/picture.PNG?raw=true)

# Ход работы:
1. Генерация синтетических кривых малоуглового рассеяния нейтронов (21000 штук) на основе модели сферических оболочек. 
Все кривые должны быть аналогичны реальным получаемым на спектрометре ЮМО малоугловым кривым, 
для чего в каждую кривую вводится случайный шум, который зависит от значений интенсивности рассеянных нейтронов и диапазона переданных импульсов q, а также уровень фона,
типичный для спектрометра ЮМО, значения ошибок по интенсивности и ошибок по q (т.е. разрешение детекторов). Кривые рассеяния генерируются для разных значений
толщины липидной мембраны, радиуса везикул и с учетом полидисперсности везикул по размерам. Вдобавок, кривые единообразно нормируются по интенсивности рассеяния для того, чтобы
в дальнейшем быть отправленными на вход нейронной сети. (Файл - generation_synthetic_curves.ipynb)
2. Все 21000 кривых фитируются моделью сферических оболочек с помощью программной утилиты Sasview для извлечения структурных параметров 
липидных мембран (толщина мембраны, радиус везикул). Данные объединяются и заносятся в датасет, где осуществляется их разметка (целевой признак - толщина). (Файл - sasview_synthetic_fits.ipynb)
3. Все синтетические кривые используются для тренировочной и валидационной выборок, которые подаются (100 точек - интенсивности I при каждом значении q) в полносвязную нейронную сеть для
предсказания толщины липидной мембраны на основе кривой рассеяния. Модель тестируется на реальных данных. (Файл - main_ANN.ipynb)
4. Тестовой выборкой являются реальные данные малоуглового рассеяния нейтронов, которые обрабатывались с помощью Sasview для извлечения структурных
параметров липидных мембран. Кривые рассеяния нормируются по интенсивности аналогично синтетическим кривым, а q-диапазон интерполируются на q-диапазон синтетических кривых. Данные объединяются и заносятся в датасет, где осуществляется их разметка. (Файл - test_data.ipynb)

# Вывод:
1. В работе были успешно сгенерированы синтетические кривые (21000 штук) малоуглового рассеяния нейтронов на липидных везикулах на основе модели сферических оболочек в q-диапазоне от 0.0085 Å-1 до 0.46 Å-1 (в каждой кривой по 100 точек). Данные сгенерированы для достаточно широкого
диапазона толщин липидных мембран (от 30 Å до 50 Å), радиусов везикул (от 100 Å до 400 Å) и параметра полидисперсности везикул по размерам (pd от 0.20 до 0.40 с шагом 0.01). Все кривые были нормированы на шкале интенсивности рассеяния. 
Далее кривые были фитированы моделью сферических оболочек с помощью программной утилиты Sasview для извлечения структурных параметров липидных мембран, которые описывает каждая кривая. 
Данные по фитированию были собраны для каждого значения полидисперсности везикул, размечены целевым признаком и объединены в один общий датасет, содержащий синтетические кривые рассеяния (и результаты фитирования) во всех вышеупомянутых интервалах структурных параметров липидных мембран. 

2. Были подготовлены реальные кривые малоуглового рассеяния нейтронов на липидных везикулах для тестовой выборки из данных, хранящихся на спектрометре ЮМО (около 500 кривых). q-диапазон реальных кривых рассеяния
был интерполирован на сетку для соответствия с диапазоном, представленным в синтетических данных. Интенсивности рассеяния были нормированы в соответствие с синтетическими кривыми рассеяния. Реальные данные также обрабатывались с помощью 
Sasview для извлечения структурных параметров липидных мембран; затем данные были размечены.

3. Все синтетические кривые использовались для тренировочной и валидационной выборок, которые подавались в полносвязную нейронную сеть для
предсказания толщины липидной мембраны. Нейронная сеть была успешно обучена на 100 эпохах. Реальные кривые рассеяния использовались в качестве тестовой выборки. Метрика MAE на тестовой выборке оказалась равной около 0.85 Å, а r2 score - 0.93, что является хорошим результатом по предсказанию 
толщины липидных мембран в везикулах на основе малоугловых кривых рассеяния нейтронов спектрометра ЮМО.

Таким образом, модель берет на вход реальные экспериментальные данные из текстового файла в виде интенсивности рассеянных нейтронов определенного q-диапазона и успешно предсказывает значение толщины липидной мембраны. 
Модель:
* важна для быстрой оценки толщины липидных мембран в широком диапазоне толщин мембран, размеров везикул и их полидисперсности (время обработки данных сокращается в 10 и более раз),
* полезна для неспециалистов в области малоуглового рассеяния нейтронов и анализа данных с установки ЮМО
* предоставляет новые возможности для оперативного управления экспериментом
